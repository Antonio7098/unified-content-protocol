name: publish-python

on:
  pull_request:
    branches:
      - main
  push:
    tags:
      - "v*"

permissions:
  contents: read

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.head.sha || github.sha }}
          fetch-depth: 0
          fetch-tags: true

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Detect version change vs base
        if: github.event_name == 'pull_request'
        id: version-change
        env:
          BASE_REF: ${{ github.base_ref }}
        run: |
          git fetch --no-tags --depth=1 origin "${BASE_REF}"
          python - <<'PY'
          import os
          import subprocess
          import tomllib
          from pathlib import Path

          base_ref = os.environ["BASE_REF"]

          def load_version_from(spec: str) -> str:
              data = subprocess.run(
                  ["git", "show", f"{spec}:Cargo.toml"],
                  check=True,
                  capture_output=True,
                  text=True,
              ).stdout
              return tomllib.loads(data)["workspace"]["package"]["version"]

          repo_version = tomllib.loads(Path("Cargo.toml").read_text())["workspace"]["package"]["version"]
          base_version = load_version_from(f"origin/{base_ref}")

          print(f"Base version: {base_version}")
          print(f"Head version: {repo_version}")

          changed = base_version != repo_version
          with open(os.environ["GITHUB_OUTPUT"], "a", encoding="utf-8") as fh:
              fh.write(f"changed={'true' if changed else 'false'}\n")
          PY

      - name: Abort (version unchanged)
        if: github.event_name == 'pull_request' && steps.version-change.outputs.changed != 'true'
        run: echo "::notice::No workspace version bump detected; skipping publish."

      - name: Install build tooling
        if: github.event_name == 'push' || steps.version-change.outputs.changed == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install build

      - name: Verify version sync (PR)
        if: github.event_name == 'pull_request' && steps.version-change.outputs.changed == 'true'
        run: python scripts/check_version_sync.py --quiet

      - name: Verify version sync (tag push)
        if: github.event_name == 'push'
        run: python scripts/check_version_sync.py --quiet --require-tag

      - name: Build distribution
        if: github.event_name == 'push' || steps.version-change.outputs.changed == 'true'
        working-directory: packages/ucp-python
        run: python -m build

      - name: Publish to PyPI
        if: github.event_name == 'push'
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/ucp-python/dist
          password: ${{ secrets.PYPI_API_TOKEN }}
