name: Publish to crates.io

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: read
  id-token: write  # Required for OIDC

jobs:
  # First, verify everything builds and tests pass
  verify:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Build workspace
        run: cargo build --release --workspace

      - name: Run tests
        run: cargo test --workspace

  # Publish crates in dependency order
  publish-crates:
    needs: verify
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        crate:
          - ucm-core
          - ucp-observe
          - ucp-translator-markdown
          - ucp-translator-html
          - ucm-engine
          - ucl-parser
          - ucp-llm
          - ucp-agent
          - ucp-cli
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Publish to crates.io
        uses: katyo/publish-crates@v2
        with:
          registry-token: ${{ secrets.CARGO_REGISTRY_TOKEN }}
          path: './crates'
          ignore-unpublished-changes: true
          crates: ${{ matrix.crate }}

  # Alternative: Use OIDC for trusted publishing (requires setup on crates.io)
  # Uncomment this section once you've added GitHub as a trusted publisher on crates.io
  #
  # publish-oidc:
  #   needs: verify
  #   runs-on: ubuntu-latest
  #   permissions:
  #     contents: read
  #     id-token: write
  #   strategy:
  #     fail-fast: false
  #     matrix:
  #       crate:
  #         - ucm-core
  #         - ucp-observe
  #         - ucp-translator-markdown
  #         - ucp-translator-html
  #         - ucm-engine
  #         - ucl-parser
  #         - ucp-llm
  #         - ucp-agent
  #         - ucp-cli
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@v4
  #
  #     - name: Install Rust toolchain
  #       uses: dtolnay/rust-toolchain@stable
  #
  #     - name: Get OIDC token
  #       id: get-token
  #       run: |
  #         # Request OIDC token from GitHub
  #         TOKEN=$(curl -s -H "Authorization: Bearer $ACTIONS_ID_TOKEN_REQUEST_TOKEN" \
  #           "$ACTIONS_ID_TOKEN_REQUEST_URL" | jq -r '.value')
  #         echo "token=$TOKEN" >> $GITHUB_OUTPUT
  #
  #     - name: Publish with OIDC
  #       run: |
  #         # Use the OIDC token to authenticate with crates.io
  #         cargo publish -p ${{ matrix.crate }}
  #       env:
  #         CARGO_REGISTRY_TOKEN: ${{ steps.get-token.outputs.token }}
